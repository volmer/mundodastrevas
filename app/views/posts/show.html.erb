<% content_for :page_title, @post %>
<% content_for :page_author, @post.user %>
<% content_for :page_description, truncate_rich(@post.content) %>
<% content_for :page_canonical_url, zine_post_url(@zine, @post) %>
<% content_for :page_image, URI(root_url) + @post.image.url %>
<% content_for :page_updated_at, @post.updated_at %>
<% content_for :page_see_also, zine_url(@zine) %>

<% content_for :layout_top do %>
  <div class="post-top"
    <% if @zine.image.file %>
      style="background-image: url(<%= @zine.image.url %>)"
    <% elsif @post.image.file %>
      style="background-image: url(<%= @post.image.url %>)"
    <% end %>
  >
  </div>
<% end %>

<div class="row">
  <div class="col-lg-8 offset-lg-2 col-md-9 offset-md-1">
    <div class="post">
      <h1><%= @post %></h1>

      <p class="author-and-date">
        <%= t '.author_and_date.html',
          user: @post.user,
          date: time_tag(@post.created_at.to_date, format: :long) %>
      </p>

      <%= image_tag @post.image.url, class: 'zine-image img-fluid' if @post.image.file.present? %>

      <div class="content"><%= sanitize @post.content %></div>

      <div class="card">
        <div class="card-block zine-link">
          <p><%= link_to @zine, @zine, title: t('.index') %></p>

          <div class="btn-group" role="group">
            <% if previous_post = @zine.posts.where('created_at < ?', @post.created_at).order(created_at: :desc).first %>
              <%= link_to zine_post_path(@zine, previous_post), class: 'btn btn-secondary', title: previous_post do %>
                &larr; <%= t '.previous' %>
              <% end %>
            <% else %>
              <button type="button" class="btn btn-secondary" disabled>
                &larr; <%= t '.previous' %>
              </button>
            <% end %>

            <%= link_to t('.index'), @zine, title: @zine, class: 'btn btn-secondary' %>

            <% if next_post = @zine.posts.where('created_at > ?', @post.created_at).order(created_at: :asc).first %>
              <%= link_to [@zine, next_post], class: 'btn btn-secondary', title: next_post do %>
                <%= t '.next' %> &rarr;
              <% end %>
            <% else %>
              <button type="button" class="btn btn-secondary" disabled>
                <%= t '.next' %> &rarr;
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <% @comments.each do |comment| %>
      <div class="comment">
        <div class="row">
          <div class="col-md-2 col-xs-3 user">
            <%= image_tag(comment.user.avatar.small.url, class: 'img-fluid rounded-circle') %>
            <%= comment.user %>
          </div>

          <div class="col-md-10 col-xs-9">
            <div class="content"><%= simple_text comment.content %></div>

            <div class="meta">
              <%= time_tag comment.created_at, format: :short %>

              <% if comment.created_at != comment.updated_at %>
                -
                <em>
                  <%= t '.comment_updated_at' %>
                  <%= time_tag comment.updated_at, format: :short %>
                </em>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
